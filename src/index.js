#!/usr/bin/env node
import load from 'pentesterland-writeups-scraper'
import yargs from 'yargs'
import pick from 'lodash/pick'

const fields = [
  'url',
  'domain',
  'title',
  'hackers',
  'weaknesses',
  'programs',
  'bounty',
  'published',
  'published_at',
]

yargs
  .scriptName('pentesterland')
  .usage('$0 <cmd> [args]')
  .command(
    'list',
    'Get list of writeups',
    {
      limit: {
        alias: 'l',
        type: 'number',
      },
      pretty: {
        alias: 'p',
        type: 'boolean',
        default: false,
      },
      group: {
        alias: 'g',
        type: 'boolean',
        default: false,
      },
      title: {
        alias: 't',
        type: 'string',
      },
      year: {
        alias: 'y',
        type: 'string',
      },
      month: {
        alias: 'm',
        type: 'string',
      },
      order: {
        alias: 'o',
        choices: ['asc', 'desc'],
        default: 'desc',
      },
      fields: {
        alias: 'f',
        type: 'array',
        choices: fields,
      },
    },
    async options => {
      let writeups = await load(
        pick(options, ['year', 'month', 'group', 'order', 'title']),
      )

      if (Array.isArray(writeups)) {
        if (options.limit) {
          writeups = writeups.slice(0, options.limit)
        }

        if (options.fields) {
          writeups = writeups.map(item => pick(item, options.fields))
        }
      }

      console.log(JSON.stringify(writeups, undefined, options.pretty ? 3 : 0))
    },
  )
  .help().argv
